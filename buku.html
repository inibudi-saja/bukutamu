<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Tamu Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            padding: 2rem 0;
        }
        
        .form-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2.5rem;
            margin: 1rem auto;
            max-width: 800px;
            width: 100%;
        }
        
        .header-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header-icon {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
        }
        
        .form-title {
            color: #333;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .form-subtitle {
            color: #666;
            font-size: 1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-submit:disabled {
            opacity: 0.7;
            transform: none;
        }
        
        .alert {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        .loading-spinner {
            display: none;
            margin-right: 0.5rem;
        }
        
        .header-banner {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 1rem auto 2rem;
            max-width: 800px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
        }
        
        .logo-container {
            flex-shrink: 0;
        }
        
        .header-logo {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }
        
        .header-text {
            text-align: center;
        }
        
        .agency-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #2c5530;
            margin: 0;
            letter-spacing: 1px;
        }
        
        .region-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #4a7c59;
            margin: 0.5rem 0;
            letter-spacing: 0.5px;
        }
        
        .datetime-display {
            font-size: 1.1rem;
            font-weight: 500;
            color: #2c5530;
            margin: 0.5rem 0;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-radius: 10px;
            border: 1px solid #4a7c59;
            display: inline-block;
        }
        
        .header-line {
            width: 100px;
            height: 3px;
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            margin: 1rem auto 0;
            border-radius: 2px;
        }
        
        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .table-header th {
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem 0.75rem;
            font-size: 0.9rem;
        }
        
        .table tbody td {
            padding: 0.75rem;
            vertical-align: middle;
            border-color: #e9ecef;
        }
        
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .guest-name {
            font-weight: 600;
            color: #333;
        }
        
        .guest-time {
            font-size: 0.85rem;
            color: #666;
        }
        
        .guest-purpose {
            font-size: 0.9rem;
            color: #555;
        }
        
        .empty-state {
            padding: 2rem;
            text-align: center;
            color: #666;
        }
        
        .summary-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }
        
        .today-card {
            border-left-color: #28a745;
        }
        
        .today-card .summary-icon {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .month-card {
            border-left-color: #007bff;
        }
        
        .month-card .summary-icon {
            background: linear-gradient(135deg, #007bff, #6610f2);
        }
        
        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .summary-content {
            flex: 1;
        }
        
        .summary-number {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            color: #333;
            line-height: 1;
        }
        
        .summary-label {
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            margin: 0.25rem 0 0;
        }
        
        .summary-date {
            font-size: 0.8rem;
            color: #999;
            font-weight: 500;
        }
        
        .footer-section {
            margin-top: 3rem;
            padding: 2rem 0;
        }
        
        .footer-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 0 auto;
            max-width: 800px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .footer-icon {
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .footer-text {
            margin: 0;
            color: #333;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .footer-text strong {
            color: #2c5530;
            font-weight: 700;
        }
        
        .footer-agency {
            color: #4a7c59;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .footer-year {
            color: #666;
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            width: 100%;
        }

        @media (max-width: 768px) {
            .form-card {
                margin: 1rem auto;
                padding: 1.5rem;
                max-width: calc(100% - 2rem);
            }
            
            .footer-content {
                margin: 0 1rem;
                padding: 1.5rem;
                max-width: calc(100% - 2rem);
            }
            
            .footer-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .footer-text {
                font-size: 0.9rem;
            }
            
            .footer-agency {
                font-size: 0.8rem;
            }
            
            .header-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .header-banner {
                margin: 1rem auto 2rem;
                padding: 1.5rem;
                gap: 1rem;
                max-width: calc(100% - 2rem);
            }
            
            .header-logo {
                width: 80px;
                height: 80px;
            }
            
            .agency-title {
                font-size: 1.4rem;
            }
            
            .region-title {
                font-size: 1.1rem;
            }
            
            .datetime-display {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }
            
            .table-header th {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }
            
            .table tbody td {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .summary-card {
                padding: 1rem;
                gap: 0.75rem;
            }
            
            .summary-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .summary-number {
                font-size: 1.5rem;
            }
            
            .summary-label {
                font-size: 0.9rem;
            }
            
            .summary-date {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <!-- Header Section -->
        <div class="header-banner">
            <div class="logo-container">
                <img src="https://i.ibb.co.com/rGYGmLGd/LOGO-KOTIM.png" alt="Logo Kotawaringin Timur" class="header-logo" onerror="this.style.display='none';">
            </div>
            <div class="header-text">
                <h1 class="agency-title">DINAS LINGKUNGAN HIDUP</h1>
                <h2 class="region-title">KABUPATEN KOTAWARINGIN TIMUR</h2>
                <div class="datetime-display" id="datetimeDisplay"></div>
                <div class="header-line"></div>
            </div>
        </div>
        
        <div class="form-card">
            <div class="header-section">
                <div class="header-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h2 class="form-title">Buku Tamu Digital</h2>
                <p class="form-subtitle">Silakan isi data diri Anda dengan lengkap</p>
            </div>
            
            <form id="guestForm">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt me-2"></i>Tanggal Kunjungan
                    </label>
                    <div class="form-control" style="background-color: #f8f9fa; color: #495057; font-weight: 600;">
                        <i class="fas fa-calendar-check me-2 text-success"></i>
                        <span id="autoDate"></span>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        <i class="fas fa-info-circle me-1"></i>Tanggal otomatis diambil dari sistem
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="nama" class="form-label">
                        <i class="fas fa-user me-2"></i>Nama Lengkap
                    </label>
                    <input type="text" class="form-control" id="nama" name="nama" placeholder="Masukkan nama lengkap" required>
                </div>
                
                <div class="form-group">
                    <label for="instansi" class="form-label">
                        <i class="fas fa-building me-2"></i>Instansi/Perusahaan
                    </label>
                    <input type="text" class="form-control" id="instansi" name="instansi" placeholder="Masukkan nama instansi/perusahaan" required>
                </div>
                
                <div class="form-group">
                    <label for="nohp" class="form-label">
                        <i class="fas fa-phone me-2"></i>No. HP
                    </label>
                    <input type="tel" class="form-control" id="nohp" name="nohp" placeholder="Contoh: 08123456789" required>
                </div>
                
                <div class="form-group">
                    <label for="keperluan" class="form-label">
                        <i class="fas fa-clipboard me-2"></i>Keperluan
                    </label>
                    <textarea class="form-control" id="keperluan" name="keperluan" rows="3" placeholder="Jelaskan keperluan kunjungan Anda" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="tujuan" class="form-label">
                        <i class="fas fa-map-marker-alt me-2"></i>Tujuan
                    </label>
                    <input type="text" class="form-control" id="tujuan" name="tujuan" placeholder="Bagian/divisi/orang yang dituju" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-submit">
                    <span class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                    <span class="btn-text">Kirim Data</span>
                </button>
            </form>
            
            <div id="alertContainer"></div>
        </div>
        
        <!-- Guest Summary Cards -->
        <div class="container" style="max-width: 800px; margin: 0 auto 2rem;">
            
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="summary-card today-card">
                        <div class="summary-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="summary-content">
                            <h3 class="summary-number" id="todayCount">0</h3>
                            <p class="summary-label" id="todayLabel">Tamu Hari Ini</p>
                            <small class="summary-date" id="todayDate"></small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="summary-card month-card">
                        <div class="summary-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="summary-content">
                            <h3 class="summary-number" id="monthCount">0</h3>
                            <p class="summary-label" id="monthLabel">Tamu Bulan Ini</p>
                            <small class="summary-date" id="monthDate"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Guests Table -->
        <div class="form-card">
            <div class="header-section">
                <div class="header-icon" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <i class="fas fa-users"></i>
                </div>
                <h2 class="form-title">10 Tamu Terakhir</h2>
                <p class="form-subtitle">Daftar pengunjung terbaru hari ini</p>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover" id="guestsTable">
                    <thead class="table-header">
                        <tr>
                            <th>No</th>
                            <th>Tanggal</th>
                            <th>Nama</th>
                            <th>Instansi</th>
                            <th>Keperluan</th>
                            <th>Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="guestsTableBody">
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Memuat data tamu...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="refreshGuestsList()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh Data
                </button>
            </div>
        </div>
        
        <!-- Footer Section -->
        <div class="footer-section">
            <div class="footer-content">
                <div class="footer-icon">
                    <i class="fas fa-code"></i>
                </div>
                <p class="footer-text">
                    Dibuat oleh <strong>Tim PPID</strong><br>
                    <span class="footer-agency">Dinas Lingkungan Hidup Kabupaten Kotawaringin Timur</span>
                </p>
                <div class="footer-year">© 2025</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to update date and time display
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            };
            
            const dateTimeString = now.toLocaleDateString('id-ID', options);
            document.getElementById('datetimeDisplay').textContent = dateTimeString + ' WIB';
            
            // Update auto date display in form
            const autoDateOptions = {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            const autoDateString = now.toLocaleDateString('id-ID', autoDateOptions);
            const autoDateElement = document.getElementById('autoDate');
            if (autoDateElement) {
                autoDateElement.textContent = autoDateString;
            }
        }
        
        // Update date/time immediately and then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        // Guest statistics
        let todayGuestCount = 0;
        let monthGuestCount = 0;
        
        // Function to update summary cards automatically
        function updateSummaryCards() {
            const now = new Date();
            
            // Always show today's date
            const todayOptions = { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            document.getElementById('todayDate').textContent = now.toLocaleDateString('id-ID', todayOptions);
            
            // Always show current month
            const monthOptions = { 
                month: 'long', 
                year: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            document.getElementById('monthDate').textContent = now.toLocaleDateString('id-ID', monthOptions);
            
            // Update counts with animation
            animateCounter('todayCount', todayGuestCount);
            animateCounter('monthCount', monthGuestCount);
        }
        
        // Function to animate counter
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = 0;
            const duration = 1500;
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function for smooth animation
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuart);
                
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }
            
            requestAnimationFrame(updateCounter);
        }
        
        // Guest data from database
        let guestsList = [];
        let allGuestsData = [];
        
        // Function to load data from localStorage
        function loadLocalData() {
            try {
                const savedData = localStorage.getItem('bukuTamuData');
                if (savedData) {
                    allGuestsData = JSON.parse(savedData);
                    console.log('Loaded', allGuestsData.length, 'guests from localStorage');
                    return true;
                }
            } catch (error) {
                console.error('Error loading localStorage:', error);
            }
            return false;
        }
        
        // Function to save data to localStorage
        function saveLocalData() {
            try {
                localStorage.setItem('bukuTamuData', JSON.stringify(allGuestsData));
                console.log('Saved', allGuestsData.length, 'guests to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        // Function to fetch data from Google Sheets
        async function fetchGuestsData() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getData', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.guests && data.guests.length > 0) {
                        allGuestsData = data.guests;
                        saveLocalData(); // Save to localStorage
                        console.log('Fetched', allGuestsData.length, 'guests from database');
                    }
                    updateDisplayData();
                } else {
                    console.log('Database not available, using local data');
                    if (!loadLocalData()) {
                        console.log('No local data available');
                    }
                    updateDisplayData();
                }
            } catch (error) {
                console.log('Database connection failed, using local data');
                if (!loadLocalData()) {
                    console.log('No local data available');
                }
                updateDisplayData();
            }
        }
        
        // Function to calculate and display automatic summaries
        function updateDisplayData() {
            const now = new Date();
            
            console.log('Updating display data with', allGuestsData.length, 'total guests');
            
            // Calculate today's guests automatically
            const today = now.toISOString().split('T')[0];
            console.log('Today date:', today);
            
            const todayData = allGuestsData.filter(guest => {
                if (!guest.tanggal) return false;
                const guestDate = new Date(guest.tanggal).toISOString().split('T')[0];
                console.log('Comparing guest date:', guestDate, 'with today:', today);
                return guestDate === today;
            });
            todayGuestCount = todayData.length;
            console.log('Today guests count:', todayGuestCount);
            
            // Calculate this month's guests automatically
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            console.log('Current month:', currentMonth);
            
            const monthData = allGuestsData.filter(guest => {
                if (!guest.tanggal) return false;
                const guestDate = new Date(guest.tanggal);
                const guestMonth = guestDate.getFullYear() + '-' + String(guestDate.getMonth() + 1).padStart(2, '0');
                console.log('Comparing guest month:', guestMonth, 'with current month:', currentMonth);
                return guestMonth === currentMonth;
            });
            monthGuestCount = monthData.length;
            console.log('Month guests count:', monthGuestCount);
            
            // Show all recent guests (last 10 from all data)
            let allRecentGuests = [...allGuestsData];
            
            // Sort by date and time (newest first)
            allRecentGuests.sort((a, b) => {
                const dateA = new Date(a.tanggal + ' ' + (a.waktu || '00:00'));
                const dateB = new Date(b.tanggal + ' ' + (b.waktu || '00:00'));
                return dateB - dateA;
            });
            
            guestsList = allRecentGuests;
            loadGuestsList();
            updateSummaryCards();
        }
        
        // Function to load and display guests list
        function loadGuestsList() {
            const tableBody = document.getElementById('guestsTableBody');
            
            if (guestsList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-users me-2"></i>Tidak ada data tamu untuk periode yang dipilih
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            guestsList.slice(0, 10).forEach((guest, index) => {
                const guestTime = guest.waktu || new Date(guest.tanggal).toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'Asia/Jakarta'
                });
                
                let guestDate = '-';
                try {
                    if (guest.tanggal) {
                        const dateObj = new Date(guest.tanggal);
                        if (!isNaN(dateObj.getTime())) {
                            guestDate = dateObj.toLocaleDateString('id-ID', {
                                day: '2-digit',
                                month: '2-digit', 
                                year: 'numeric',
                                timeZone: 'Asia/Jakarta'
                            });
                        }
                    }
                } catch (error) {
                    console.log('Date parsing error:', error);
                    guestDate = '-';
                }
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="guest-time">${guestDate}</td>
                        <td class="guest-name">${guest.nama || '-'}</td>
                        <td>${guest.instansi || '-'}</td>
                        <td class="guest-purpose">${guest.keperluan || '-'}</td>
                        <td class="guest-time">${guestTime}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // Function to refresh guests list
        function refreshGuestsList() {
            const tableBody = document.getElementById('guestsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Memuat data tamu...
                    </td>
                </tr>
            `;
            
            // Fetch fresh data from database
            fetchGuestsData();
        }
        

        
        // Function to add new guest to the list
        function addGuestToList(guestData) {
            const now = new Date();
            const newGuest = {
                tanggal: now.toISOString().split('T')[0], // Always use today's date
                nama: guestData.nama,
                instansi: guestData.instansi,
                nohp: guestData.nohp,
                keperluan: guestData.keperluan,
                tujuan: guestData.tujuan,
                waktu: now.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'Asia/Jakarta'
                })
            };
            
            // Add to beginning of arrays
            guestsList.unshift(newGuest);
            allGuestsData.unshift(newGuest);
            
            // Save to localStorage immediately
            saveLocalData();
            
            // Keep only last 100 guests in memory to prevent storage overflow
            if (allGuestsData.length > 100) {
                allGuestsData = allGuestsData.slice(0, 100);
                saveLocalData();
            }
            
            // Recalculate summaries and update display
            updateDisplayData();
        }
        
        // Load initial data
        setTimeout(() => {
            // Load local data first for immediate display
            if (loadLocalData()) {
                updateDisplayData();
                console.log('Displaying local data immediately');
            } else {
                updateDisplayData(); // Show empty state
            }
            
            // Then try to fetch fresh data from database
            fetchGuestsData();
        }, 500);
        
        // URL Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzf5h1NRBwhfrYhGHTIOx6FGbRqiUV59yba_xK02IlVIjzno6Iu4Q10Cf0gwihATqlW/exec';
        
        // Handle form submission
        document.getElementById('guestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.querySelector('.btn-submit');
            const loadingSpinner = document.querySelector('.loading-spinner');
            const btnText = document.querySelector('.btn-text');
            const alertContainer = document.getElementById('alertContainer');
            
            // Show loading state
            submitBtn.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            btnText.textContent = 'Mengirim...';
            alertContainer.innerHTML = '';
            
            try {
                // Collect form data
                const formData = new FormData(this);
                const now = new Date();
                const data = {
                    tanggal: now.toISOString().split('T')[0], // Always use today's date
                    nama: formData.get('nama'),
                    instansi: formData.get('instansi'),
                    nohp: formData.get('nohp'),
                    keperluan: formData.get('keperluan'),
                    tujuan: formData.get('tujuan'),
                    waktu: now.toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        timeZone: 'Asia/Jakarta'
                    })
                };
                
                // Send data to Google Apps Script
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Since we're using no-cors mode, we can't read the response
                // We'll assume success if no error is thrown
                showAlert('success', 'Data berhasil dikirim! Terima kasih telah mengisi buku tamu.');
                
                // Add guest to the list and update counters
                addGuestToList(data);
                
                // Refresh data from database to get latest counts
                setTimeout(() => {
                    fetchGuestsData();
                }, 2000);
                
                // Reset form
                this.reset();
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('danger', 'Terjadi kesalahan saat mengirim data. Silakan coba lagi atau hubungi administrator.');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                btnText.textContent = 'Kirim Data';
            }
        });
        
        // Function to show alert messages
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
            `;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 300);
            }, 5000);
        }
        
        // Format phone number input
        document.getElementById('nohp').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('0')) {
                value = value;
            } else if (value.startsWith('62')) {
                value = '0' + value.substring(2);
            }
            e.target.value = value;
        });
        
        // Auto-resize textarea
        document.getElementById('keperluan').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'981eabf105e914b5',t:'MTc1ODM0MzUwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
